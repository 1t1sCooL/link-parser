# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ Node.js 20 (–Ω–∞ –±–∞–∑–µ Debian)
FROM node:20

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cron –∏ –æ—á–∏—â–∞–µ–º –∫—ç—à apt
RUN apt-get update && apt-get install -y cron && rm -rf /var/lib/apt/lists/*

# –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY package*.json ./
RUN npm install --production

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY . .

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π
RUN chmod +x /app/run_parser.sh

# üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω—è–µ–º 'node ' –Ω–∞ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ node
# –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤ run_parser.sh –Ω–∞–ø–∏—Å–∞–Ω–æ –ø—Ä–æ—Å—Ç–æ "node ..."
RUN sed -i 's|node |/usr/local/bin/node |g' /app/run_parser.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º cron: –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ crontab –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root
# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 04:00 –ø–æ UTC
# –í–µ—Å—å –≤—ã–≤–æ–¥ (stdout + stderr) –∏–¥—ë—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Üí –≤–∏–¥–µ–Ω –≤ kubectl logs
RUN echo '0 4 * * * /app/run_parser.sh >> /proc/1/fd/1 2>&1' | crontab -

# –ü—Ä–æ–≤–µ—Ä–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
# RUN crontab -l

# –ó–∞–ø—É—Å–∫–∞–µ–º cron –≤ foreground ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
CMD ["cron", "-f"]
